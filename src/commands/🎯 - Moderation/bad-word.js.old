const Discord = require('discord.js');
const fs = require('fs');

const colors = require('../../lists/colors.json');
const default_embeds_color = colors["default_embed"];
const error_color = colors["error_embed"];

const emojis = require("../../lists/emojis.json")
const db = require("../../db.json");
const language = require("../../lists/language.json");

function SaveDBs() { // Fonction pour sauvegarder la base de donnÃ©es
    fs.writeFile("./db.json", JSON.stringify(db, null, 4), (err) => {
        if (err) {
            error_embed.addFields(
                {name: `Une erreur est survenue : `, value: `${err}`}
            )
            message.channel.send(error_embed);
            error_embed.fields = [];
        }
    });
}


module.exports = {
    name: 'bad-word',
    description: 'Configures bad words',
    category: 'ðŸŽ¯ - Moderation',
    aliases: ['forbidden-words'],
    run: (client, message, args) =>{
        const guildLang = db[message.guild.id]["language"]

        const error_embed = new Discord.MessageEmbed()
            .setColor(`${error_color}`)
            .setAuthor("Toaster", "http://adloteam.42web.io/adloteam/Toaster/MULTI.png")
            .setTitle(`${emojis["no"]} | ${language[guildLang]["Error"]}`)
            .setFooter("Toaster - Created by Adloya")
            .setTimestamp();

        if(message.member.hasPermission("MANAGE_MESSAGES")){
            let arg = message.content.trim().split(/ +/g)

            if(!arg[1]){
                error_embed.addFields(
                    { name: `${language[guildLang]["ErrorBasic"]}`, value: `${language[guildLang]["InvalidArg"]}` }
                );
                message.channel.send(error_embed);
                error_embed.fields = [];
                return;
            }
            else if(arg[1] == "add"){
                if(!arg[2]){
                    error_embed.addFields(
                        { name: `${language[guildLang]["ErrorBasic"]}`, value: `${language[guildLang]["InvalidArg"]}` }
                    );
                    message.channel.send(error_embed);
                    error_embed.fields = [];
                    return;
                }else{
                    if(db[message.guild.id]["badwords"][arg[2]]){
                        error_embed.addFields(
                            { name: `${language[guildLang]["ErrorBasic"]}`, value: `${arg[2]} ${language[guildLang]["AlreadyExists"]}` }
                        );
                        message.channel.send(error_embed);
                        error_embed.fields = [];
                        return;
                    }else{
                        db[message.guild.id]["badwords"][arg[2]] = "yes";
                        SaveDBs();
                        const add_badwords = new Discord.MessageEmbed()
                            .setColor(`${default_embeds_color}`)
                            .setAuthor("Toaster", "http://adloteam.42web.io/adloteam/Toaster/MULTI.png")
                            .setDescription(`${language[guildLang]["AddedBadword"]}`)
                            .setFooter("Toaster - Created by Adloya")
                            .setTitle(`${emojis["yes"]} | ${language[guildLang]["BadwordTitle"]}`)
                            .setTimestamp()
                            .addFields(
                                {name: `${language[guildLang]["BadwordAdded"]}`, value: arg[2]}
                            );
                        message.channel.send(add_badwords);
                    }
                }
            }
            else if(arg[1] == "remove"){
                if(!arg[2]){
                    error_embed.addFields(
                        { name: `${language[guildLang]["ErrorBasic"]}`, value: `${language[guildLang]["InvalidArg"]}` }
                    );
                    message.channel.send(error_embed);
                    error_embed.fields = [];
                    return;
                }else{
                    if(!db[message.guild.id]["badwords"][arg[2]]){
                        error_embed.addFields(
                            { name: `${language[guildLang]["ErrorBasic"]}`, value: `${arg[2]} ${language[guildLang]["DoesntExists"]}` }
                        );
                        message.channel.send(error_embed);
                        error_embed.fields = [];
                        return;
                    }else{
                        delete(db[message.guild.id]["badwords"][arg[2]]);
                        SaveDBs();
                        const rem_badwords = new Discord.MessageEmbed()
                            .setColor(`${default_embeds_color}`)
                            .setAuthor("Toaster", "http://adloteam.42web.io/adloteam/Toaster/MULTI.png")
                            .setDescription(`${language[guildLang]["RemovedBadWord"]}`)
                            .setFooter("Toaster - Created by Adloya")
                            .setTitle(`${emojis["no"]} | ${language[guildLang]["BadwordRemTitle"]}`)
                            .setTimestamp()
                            .addFields(
                                {name: `${language[guildLang]["BadwordRemoved"]}`, value: arg[2]}
                            );
                        message.channel.send(rem_badwords);
                    }
                }
                
            }else if(arg[1] == "list"){
                const list_badwords = new Discord.MessageEmbed()
                    .setColor(`${default_embeds_color}`)
                    .setAuthor("Toaster", "http://adloteam.42web.io/adloteam/Toaster/MULTI.png")
                    .setDescription(`${language[guildLang]["ListBadWord"]}`)
                    .setFooter("Toaster - Created by Adloya")
                    .setTitle(`${language[guildLang]["BadwordListTitle"]}`)
                    .setTimestamp()
                    
                var i;
                for(i = 0;i < db[message.guild.id]["badwords"]; i++){
                    list_badwords.addField(i, db[message.guild.id]["badwords"][i])
                }
                message.channel.send(list_badwords)
            }
            else{
                error_embed.addFields(
                    { name: `${language[guildLang]["ErrorBasic"]}`, value: `${language[guildLang]["Cmd404Title"]} (add / remove)` }
                );
                message.channel.send(error_embed);
                error_embed.fields = [];
                return; 
            }


        }else{
            error_embed.addFields(
                { name: `${language[guildLang]["ErrorBasic"]}`, value: `${language[guildLang]["MissingPermission"]}` }
            );
            message.channel.send(error_embed);
            error_embed.fields = [];
            return;
        }
    }
}